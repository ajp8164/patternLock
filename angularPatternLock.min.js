/*
    patternLock.js v 1.0.2
    Author: Sudhanshu Yadav
    Copyright (c) 2015,2016 Sudhanshu Yadav - ignitersworld.com , released under the MIT license.
    Demo on: ignitersworld.com/lab/patternLock.html

    Adapted as an angular directive by Andy Phillipson, 2/2018
*/
!function(e,t){"function"==typeof define&&define.amd?define(["angular"],t):"object"==typeof module&&module.exports?module.exports=t(require("angular")):e.angularPatternLock=t(e.angular)}(this,function(e){return e.module("angular-pattern-lock",[]).factory("patternLock",["$document","$window",function(t,n){var i=window.document,a=function(){},r={};function o(t){for(var n=t.holder,i=t.option,a=i.matrix,r=i.margin,o=i.radius,l=['<ul class="patt-wrap" style="padding:'+r+'px">'],s=0,d=a[0]*a[1];s<d;s++)l.push('<li class="patt-circ" style="margin:'+r+"px; width : "+2*o+"px; height : "+2*o+"px; -webkit-border-radius: "+o+"px; -moz-border-radius: "+o+"px; border-radius: "+o+'px; "><div class="patt-dots"></div></li>');l.push("</ul>"),e.element(e.element(n).html(l.join(""))).css({width:a[1]*(2*o+2*r)+2*r+"px",height:a[0]*(2*o+2*r)+2*r+"px"}),t.pattCircle=e.element(t.holder[0].getElementsByClassName("patt-circ"))}function l(e,t,n,i){var a=t-e,r=i-n;return{length:Math.ceil(Math.sqrt(a*a+r*r)),angle:Math.round(180*Math.atan2(r,a)/Math.PI)}}var s=function(t,n){t.preventDefault();var a=r[n.token];if(!a.disabled){a.option.patternVisible||e.element(a.holder).addClass("patt-hidden");var o="touchstart"==t.type?"touchmove":"mousemove",l="touchstart"==t.type?"touchend":"mouseup";e.element(this).on(o,function(e){d.call(this,e,n)}),a.touchMove=o,e.element(i).one(l,function(){p.call(this,t,n)});var s=e.element(a.holder[0].getElementsByClassName("patt-wrap"))[0].getBoundingClientRect();a.wrapTop=s.top,a.wrapLeft=s.left,n.reset()}},d=function(t,n){t.preventDefault();var a=t.clientX||t.touches[0].clientX,o=t.clientY||t.touches[0].clientY,s=r[n.token],d=s.option,p=s.pattCircle,u=s.patternAry,c=s.getIdxFromPoint(a,o),m=c.idx,h=s.mapperFunc(m)||m;if(u.length>0){var f=l(s.lineX1,c.x,s.lineY1,c.y);e.element(s.line).css({width:f.length+10+"px",transform:"rotate("+f.angle+"deg)"})}if(m&&(d.allowRepeat&&u[u.length-1]!==h||-1===u.indexOf(h))){var v=e.element(p[m-1])[0];if(s.lastPosObj)for(var g=s.lastPosObj,w=g.i,x=g.j,b=c.i-g.i>0?1:-1,j=c.j-g.j>0?1:-1,y=Math.abs(c.i-w),P=Math.abs(c.j-x);0===y&&P>1||0===P&&y>1||P==y&&P>1;){w=y?w+b:w,x=P?x+j:x,y=Math.abs(c.i-w),P=Math.abs(c.j-x);var k=(x-1)*d.matrix[1]+w,M=s.mapperFunc(k)||k;(d.allowRepeat||-1==u.indexOf(M))&&(s.addDirectionClass({i:w,j:x}),s.markPoint(e.element(i.querySelector(p[M-1]))[0],M),s.addLine({i:w,j:x}))}s.lastPosObj&&s.addDirectionClass(c),s.markPoint(v,h),s.addLine(c),s.lastPosObj=c}},p=function(t,n){t.preventDefault();var i=r[n.token],a=i.option,o=i.patternAry.join(a.delimiter);e.element(i.holder).off(i.touchMove).removeClass("patt-hidden"),o&&(a.onDraw(o),i.line.remove(),i.rightPattern&&(o==i.rightPattern?i.onSuccess():(i.onError(),n.error())))};function u(){}function c(t,n){var i=this,l=i.token=Math.random(),d=r[l]=new u,p=d.holder=e.element(t);if(0!==p.length){d.object=i;var m=n.onDraw;(n=JSON.parse(JSON.stringify(n))).onDraw=m;var h={onDraw:a},f=(n=n||{}).matrix;f&&f[0]*f[1]>9&&(h.delimiter=","),n=d.option=e.extend({},c.defaults,h,n),o(d),e.element(p).addClass("patt-holder"),"static"==e.element(p).css("position")&&e.element(p).css("position","relative"),e.element(p).on("touchstart mousedown",function(e){s.call(this,e,i)});var v=n.mapper;d.mapperFunc="object"==typeof v?function(e){return v[e]}:"function"==typeof v?v:a,d.option.mapper=null}}return u.prototype={constructor:u,getIdxFromPoint:function(e,t){var n=this.option,i=n.matrix,a=e-this.wrapLeft,r=t-this.wrapTop,o=null,l=n.margin,s=2*n.radius+2*l,d=Math.ceil(a/s),p=Math.ceil(r/s),u=a%s,c=r%s;return d<=i[1]&&p<=i[0]&&u>2*l&&c>2*l&&(o=(p-1)*i[1]+d),{idx:o,i:d,j:p,x:a,y:r}},markPoint:function(t,n){e.element(t).addClass("hovered"),this.patternAry.push(n),this.lastElm=t},addLine:function(t){var n=this,i=n.patternAry,a=n.option,r=a.lineOnMove,o=a.margin,s=a.radius,d=(t.i-1)*(2*o+2*s)+2*o+s,p=(t.j-1)*(2*o+2*s)+2*o+s;if(i.length>1){var u=l(n.lineX1,d,n.lineY1,p);e.element(n.line).css({width:u.length+10+"px",transform:"rotate("+u.angle+"deg)"}),r||n.line.show()}var c=e.element('<div class="patt-lines" style="top:'+(p-5)+"px; left:"+(d-5)+'px"></div>')[0];n.line=c,n.lineX1=d,n.lineY1=p,n.holder.append(c),r||n.line.hide()},addDirectionClass:function(t){var n=this.lastElm,i=this.line,a=this.lastPosObj,r=[];t.j-a.j>0?r.push("s"):t.j-a.j<0&&r.push("n"),t.i-a.i>0?r.push("e"):t.i-a.i<0&&r.push("w"),(r=r.join("-"))&&(e.element(i).addClass(r+" dir"),e.element(n).addClass(r+" dir"))}},c.prototype={constructor:c,option:function(e,t){var n=r[this.token],i=n.option;if(void 0===t)return i[e];i[e]=t,"margin"!=e&&"matrix"!=e&&"radius"!=e||o(n)},getPattern:function(){var e=r[this.token];return(e.patternAry||[]).join(e.option.delimiter)},setPattern:function(e){var t=r[this.token],n=t.option,i=n.matrix,o=n.margin,l=n.radius;if(n.enableSetPattern){"string"==typeof e&&(e=e.split(n.delimiter)),this.reset(),t.wrapLeft=0,t.wrapTop=0;for(var s=0;s<e.length;s++){var p=e[s]-1,u=p%i[1]*(2*o+2*l)+2*o+l,c=Math.floor(p/i[1])*(2*o+2*l)+2*o+l;d.call(null,{clientX:u,clientY:c,preventDefault:a},this)}}},enable:function(){r[this.token].disabled=!1},disable:function(){r[this.token].disabled=!0},reset:function(){var t=r[this.token];t.pattCircle.removeClass("hovered dir s n w e s-w s-e n-w n-e"),e.element(t.holder[0].getElementsByClassName("patt-lines")).remove(),t.patternAry=[],t.lastPosObj=null,e.element(t.holder).removeClass("patt-error")},error:function(){e.element(r[this.token].holder).addClass("patt-error")},checkForPattern:function(e,t,n){var i=r[this.token];i.rightPattern=e,i.onSuccess=t||a,i.onError=n||a}},c.defaults={matrix:[3,3],margin:20,radius:25,patternVisible:!0,lineOnMove:!0,delimiter:"",enableSetPattern:!1,allowRepeat:!1},c}]).directive("patternLock",["patternLock",function(e){return{restrict:"E",scope:{onInit:"&",onDraw:"=",matrix:"=matrix",margin:"=margin",radius:"=radius",patternVisible:"=patternVisible",lineOnMove:"=lineOnMove",enableSetPattern:"=enableSetPattern",delimiter:"=delimiter",allowRepeat:"=allowRepeat"},replace:!0,template:'<div id="lockPattern"></div>',link:function(t,n){var i=new e(n,{onDraw:t.onDraw,matrix:t.matrix,margin:t.margin,radius:t.radius,patternVisible:t.patternVisible,lineOnMove:t.lineOnMove,enableSetPattern:t.enableSetPattern,delimiter:t.delimiter,allowRepeat:t.allowRepeat});t.onInit({lock:i})}}}])});